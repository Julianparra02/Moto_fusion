<div class="flex flex-col items-center px-40 mt-10">
    @if(id){
    <h1 class="text-2xl font-bold mb-6">Update Product</h1>
    } @else {
    <h1 class="text-2xl font-bold mb-6">Add New Product</h1>
    }

    <form class="shadow p-6 w-full max-w-4xl bg-white rounded-lg" [formGroup]="productForm" (ngSubmit)="id ? updateProduct() : addProduct()">

        <!-- INFORMACIÓN BÁSICA -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Información Básica</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <mat-form-field class="w-full">
                    <mat-label>Category</mat-label>
                    <mat-select formControlName="categoryId">
                        @for(item of categories; track $index){
                        <mat-option [value]="item._id">{{item.name}}</mat-option>
                        }
                    </mat-select>
                    @if(productForm.get('categoryId')?.invalid && productForm.get('categoryId')?.touched){
                    <mat-error>Category is required</mat-error>
                    }
                </mat-form-field>

                <mat-form-field class="w-full">
                    <mat-label>Brand</mat-label>
                    <mat-select formControlName="brandId">
                        @for(item of brand; track $index){
                        <mat-option [value]="item._id">{{item.name}}</mat-option>
                        }
                    </mat-select>
                    @if(productForm.get('brandId')?.invalid && productForm.get('brandId')?.touched){
                    <mat-error>Brand is required</mat-error>
                    }
                </mat-form-field>

                <mat-form-field class="w-full">
                    <mat-label>Name</mat-label>
                    <input matInput type="text" formControlName="name"> @if(productForm.get('name')?.invalid && productForm.get('name')?.touched){
                    <mat-error>
                        @if(productForm.get('name')?.errors?.['required']){ Name is required } @if(productForm.get('name')?.errors?.['minlength']){ Name must be at least 5 characters }
                    </mat-error>
                    }
                </mat-form-field>

                <mat-form-field class="w-full">
                    <mat-label>Reference</mat-label>
                    <input matInput type="text" formControlName="reference"> @if(productForm.get('reference')?.invalid && productForm.get('reference')?.touched){
                    <mat-error>
                        @if(productForm.get('reference')?.errors?.['required']){ Reference is required } @if(productForm.get('reference')?.errors?.['minlength']){ Reference must be at least 12 characters }
                    </mat-error>
                    }
                </mat-form-field>

                <mat-form-field class="w-full">
                    <mat-label>Price</mat-label>
                    <input matInput type="number" formControlName="price" min="0"> @if(productForm.get('price')?.invalid && productForm.get('price')?.touched){
                    <mat-error>Price is required and must be positive</mat-error>
                    }
                </mat-form-field>
            </div>

            <mat-form-field class="w-full mt-4">
                <mat-label>Description</mat-label>
                <textarea matInput type="text" rows="4" formControlName="description"></textarea> @if(productForm.get('description')?.invalid && productForm.get('description')?.touched){
                <mat-error>
                    @if(productForm.get('description')?.errors?.['required']){ Description is required } @if(productForm.get('description')?.errors?.['minlength']){ Description must be at least 10 characters }
                </mat-error>
                }
            </mat-form-field>
            <div class="w-full flex gap-8">
                <mat-checkbox formControlName="isFeatured">Is Featured</mat-checkbox>
                <mat-checkbox formControlName="isNewProduct">Is New</mat-checkbox>
            </div>
        </div>

        <!-- COMPATIBILIDAD PRINCIPAL -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Compatibilidad Principal</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- FALTABA: Campo Marca para compatibilidad principal -->
                <mat-form-field class="w-full">
                    <mat-label>Marca de Moto</mat-label>
                    <input matInput type="text" formControlName="marca" placeholder="Ej: Yamaha"> @if(productForm.get('marca')?.invalid && productForm.get('marca')?.touched){
                    <mat-error>Marca is required</mat-error>
                    }
                </mat-form-field>

                <mat-form-field class="w-full">
                    <mat-label>Modelo</mat-label>
                    <input matInput type="text" formControlName="modelo" placeholder="Ej: YZF R15"> @if(productForm.get('modelo')?.invalid && productForm.get('modelo')?.touched){
                    <mat-error>Modelo is required</mat-error>
                    }
                </mat-form-field>

                <mat-form-field class="w-full">
                    <mat-label>Año</mat-label>
                    <input matInput type="number" formControlName="año" placeholder="Ej: 2022" min="2000" max="2024"> @if(productForm.get('año')?.invalid && productForm.get('año')?.touched){
                    <mat-error>Año is required</mat-error>
                    }
                </mat-form-field>
            </div>
        </div>

        <!-- FALTABA: COMPATIBILIDAD EXTENDIDA -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Otras Motos Compatibles</h2>
                <button type="button" mat-raised-button color="primary" (click)="addCompatibility()">
                    <mat-icon>add</mat-icon>
                    Añadir Compatibilidad
                </button>
            </div>

            <div formArrayName="compatibilidad">
                @for(comp of getCompatibilidadControls(); track $index; let i = $index) {
                <div [formGroupName]="i" class="border border-gray-200 p-4 rounded-lg mb-4 bg-gray-50">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-lg font-medium text-gray-600">Compatibilidad {{i + 1}}</h3>
                        @if(compatibilidad.length > 1){
                        <button type="button" mat-icon-button color="warn" (click)="removeCompatibility(i)">
                            <mat-icon>delete</mat-icon>
                        </button> }
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <mat-form-field class="w-full">
                            <mat-label>Marca</mat-label>
                            <input matInput type="text" formControlName="marca" placeholder="Ej: Honda"> @if(comp.get('marca')?.invalid && comp.get('marca')?.touched){
                            <mat-error>Marca is required</mat-error>
                            }
                        </mat-form-field>

                        <mat-form-field class="w-full">
                            <mat-label>Modelo</mat-label>
                            <input matInput type="text" formControlName="modelo" placeholder="Ej: CBR 150"> @if(comp.get('modelo')?.invalid && comp.get('modelo')?.touched){
                            <mat-error>Modelo is required</mat-error>
                            }
                        </mat-form-field>

                        <mat-form-field class="w-full">
                            <mat-label>Año</mat-label>
                            <input matInput type="number" formControlName="año" placeholder="Ej: 2021" min="2000" max="2024"> @if(comp.get('año')?.invalid && comp.get('año')?.touched){
                            <mat-error>Año is required</mat-error>
                            }
                        </mat-form-field>
                    </div>
                </div>
                }
            </div>
        </div>

        <!-- IMÁGENES -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-700">Images</h2>
                <div class="flex gap-2">
                    <button type="button" mat-raised-button color="primary" (click)="addImage()">
                        <mat-icon>add</mat-icon>
                        Add Image
                    </button>
                    <button type="button" mat-raised-button color="warn" (click)="removeImage()" [disabled]="images.length <= 1">
                        <mat-icon>remove</mat-icon>
                        Remove Image
                    </button>
                </div>
            </div>

            <div formArrayName="images">
                @for(item of images.controls; track $index; let i = $index){
                <mat-form-field class="w-full mb-2">
                    <mat-label>Image URL {{i + 1}}</mat-label>
                    <input matInput type="text" [formControlName]="i" placeholder="https://example.com/image.jpg" />
                </mat-form-field>
                }
            </div>
        </div>

        <!-- BOTONES DE ACCIÓN -->
        <div class="flex justify-center gap-4 pt-4 border-t border-gray-200">
            <button type="button" mat-raised-button color="warn" routerLink="/admin/products">
                <mat-icon>cancel</mat-icon>
                Cancel
            </button> @if(id){
            <button type="submit" mat-raised-button color="primary" [disabled]="productForm.invalid">
                <mat-icon>update</mat-icon>
                Update Product
            </button> } @else {
            <button type="submit" mat-raised-button color="primary" [disabled]="productForm.invalid">
                <mat-icon>add</mat-icon>
                Add Product
            </button> }
        </div>
    </form>
</div>